# clangd-tidy: A faster alternative to clang-tidy

## Motivation

[clang-tidy](https://clang.llvm.org/extra/clang-tidy/) is a great tool for static analysis of C++ code. However, it is [well-known](https://www.google.com/search?q=clang-tidy+slow) that clang-tidy takes **forever** to run on large codebases, especially when you enable a lot of checks. You might have to struggling on disabling valuable checks, only to make clang-tidy finish in a reasonable time.

Meanwhile, [clangd](https://clangd.llvm.org/), the language server which has built-in support for clang-tidy, is [observed](https://stackoverflow.com/questions/76531831/why-is-clang-tidy-in-clangd-so-much-faster-than-run-clang-tidy-itself) to be much faster than clang-tidy itself to run the same checks -- it shows the diagnostics almost instantly when you open a file in your editor. AFAIK, the main reason of the difference is that clang-tidy actually performs checks in all headers (although it suppresses the warnings from them), while clangd only builds AST from the headers. Unfortunately, it seems that LLVM has no plan about speeding up the standalone version of clang-tidy.

This project aims to provide a faster alternative to clang-tidy, by leveraging the speed of clangd. It is a wrapper of clangd, which runs clangd in the background and collects the diagnostics from it. It is designed to be a drop-in replacement of clang-tidy, so that you can use it with your existing build system or CI scripts.

## In comparison with clang-tidy

Pros:
- clangd-tidy is much faster than clang-tidy (over 10x in my experience).
- clangd-tidy can check header files individually, even if they are not included in the compilation database.
- clangd-tidy groups diagnostics by files -- no more duplicated diagnostics from the same header!
- clangd-tidy supports [`.clangd` configuration files](https://clangd.llvm.org/config), where you can do some useful things which clang-tidy does not support. For example:
    - Removing unknown compiler flags from the compilation database.
        ```yaml
        CompileFlags:
          Remove: -fabi*
        ```
    - Adding IWYU include checks.
        ```yaml
        Diagnostics:
          # Available in clangd-14
          UnusedIncludes: Strict
          # Require clangd-17
          MissingIncludes: Strict
        ```
- Refer to #Usage for more features.

Cons:
- clangd-tidy does not support `--fix` option. (But you might prefer to use code actions provided by your editor, if you have clangd properly configured. Afterall, clangd-tidy is basically designed for speed up CI checks.)
- clangd-tidy will silently disable [several](https://searchfox.org/llvm/rev/cb7bda2ace81226c5b33165411dd0316f93fa57e/clang-tools-extra/clangd/TidyProvider.cpp#199-227) checks which are not supported by clangd.
- The diagnostics generated by clangd-tidy are less prettier than clang-tidy.

## Prerequisites

- Python 3.8+ (may work on older versions, but not tested)
- tqdm (optional)

## Usage

```
usage: clangd-tidy [-h] [-p COMPILE_COMMANDS_DIR] [-j JOBS] [-o OUTPUT]
                   [--clangd-executable CLANGD_EXECUTABLE]
                   [--allow-extensions ALLOW_EXTENSIONS]
                   [--fail-on-severity SEVERITY] [--tqdm] [-v]
                   filename [filename ...]

Run clangd with clang-tidy and output diagnostics. This aims to serve as a faster
alternative to clang-tidy.

positional arguments:
  filename              Files to check. Files whose extensions are not in
                        ALLOW_EXTENSIONS will be ignored.

options:
  -h, --help            show this help message and exit
  -p COMPILE_COMMANDS_DIR, --compile-commands-dir COMPILE_COMMANDS_DIR
                        Specify a path to look for compile_commands.json. If path is
                        invalid, clangd will look in the current directory and
                        parent paths of each source file. [default: build]
  -j JOBS, --jobs JOBS  Number of async workers used by clangd. Background index
                        also uses this many workers. [default: 1]
  -o OUTPUT, --output OUTPUT
                        Output file for diagnostics. [default: stdout]
  --clangd-executable CLANGD_EXECUTABLE
                        Path to clangd executable. [default: clangd]
  --allow-extensions ALLOW_EXTENSIONS
                        A comma-separated list of file extensions to allow.
                        [default: c,h,cpp,cc,cxx,hpp,hh,hxx,cu,cuh]
  --fail-on-severity SEVERITY
                        On which severity of diagnostics this program should exit
                        with non-zero status. Candidates: error, warn, hint.
                        [default: hint]
  --tqdm                Show progress bar (require tqdm).
  -v, --verbose         Print verbose output from clangd.

Find more information on https://github.com/lljbash/clangd-tidy.
```

## Acknowledgement

Thanks to @yeger00 for his [pylspclient](https://github.com/yeger00/pylspclient).

Thanks to [clangd](https://clangd.llvm.org/) and [clang-tidy](https://clang.llvm.org/extra/clang-tidy/) for their great work!
